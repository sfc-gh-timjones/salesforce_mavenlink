name: time_entries_view
description: >
  Semantic view for Mavenlink Time Entries. Part of the Per-Fact Agent approach.
  Use this view for questions about time tracking, consultant hours,
  billability, and labor costs.

tables:
  - name: consultants
    description: Consultant/User dimension.
    synonyms:
      - users
      - team_members
    base_table:
      database: ANALYTICS
      schema: MART
      table: DIM_USER
    dimensions:
      - name: ml_user_id
        description: Mavenlink user ID
        synonyms:
          - consultant_id
        expr: ML_USER_ID
        data_type: VARCHAR
      - name: consultant_name
        description: Consultant name
        synonyms:
          - name
        expr: FULL_NAME
        data_type: VARCHAR
      - name: title
        description: Job title
        expr: TITLE
        data_type: VARCHAR
    facts:
      - name: total_hours
        description: Total hours logged
        expr: ML_TOTAL_HOURS
        data_type: NUMBER
      - name: utilization_pct
        description: Utilization percentage
        expr: ML_UTILIZATION_PCT
        data_type: NUMBER
    metrics:
      - name: avg_utilization
        description: Average utilization
        expr: AVG(ML_UTILIZATION_PCT)
    filters:
      - name: mavenlink_users
        description: Users with Mavenlink accounts
        expr: "ML_USER_ID IS NOT NULL"

  - name: time_entries
    description: Time entry fact table.
    synonyms:
      - timesheets
      - hours
    base_table:
      database: ANALYTICS
      schema: MART
      table: FACT_TIME_ENTRY
    dimensions:
      - name: time_entry_id
        description: Time entry ID
        expr: TIME_ENTRY_ID
        data_type: VARCHAR
        unique: true
      - name: workspace_id
        description: Project ID
        synonyms:
          - project_id
        expr: WORKSPACE_ID
        data_type: VARCHAR
      - name: user_id
        description: Consultant ID
        expr: USER_ID
        data_type: VARCHAR
      - name: is_billable
        description: Is billable
        expr: IS_BILLABLE
        data_type: BOOLEAN
      - name: is_approved
        description: Is approved
        expr: IS_APPROVED
        data_type: BOOLEAN
      - name: project_title
        description: Project name
        expr: PROJECT_TITLE
        data_type: VARCHAR
      - name: task_title
        description: Task name
        expr: TASK_TITLE
        data_type: VARCHAR
      - name: user_name
        description: Consultant name
        expr: USER_NAME
        data_type: VARCHAR
    time_dimensions:
      - name: date_performed
        description: Work date
        synonyms:
          - work_date
        expr: DATE_PERFORMED
        data_type: DATE
    facts:
      - name: time_in_hours
        description: Hours logged
        synonyms:
          - hours
        expr: TIME_IN_HOURS
        data_type: NUMBER
      - name: rate_dollars
        description: Bill rate
        expr: RATE_DOLLARS
        data_type: NUMBER
      - name: cost_rate_dollars
        description: Cost rate
        expr: COST_RATE_DOLLARS
        data_type: NUMBER
      - name: revenue_dollars
        description: Revenue generated
        expr: REVENUE_DOLLARS
        data_type: NUMBER
      - name: cost_dollars
        description: Labor cost
        expr: COST_DOLLARS
        data_type: NUMBER
    metrics:
      - name: total_hours
        description: Total hours
        expr: SUM(TIME_IN_HOURS)
      - name: billable_hours
        description: Billable hours
        expr: SUM(CASE WHEN IS_BILLABLE THEN TIME_IN_HOURS ELSE 0 END)
      - name: total_revenue
        description: Total revenue
        expr: SUM(REVENUE_DOLLARS)
      - name: total_cost
        description: Total cost
        expr: SUM(COST_DOLLARS)
      - name: gross_margin
        description: Revenue minus cost
        expr: SUM(REVENUE_DOLLARS) - SUM(COST_DOLLARS)
      - name: billability_rate
        description: Billability percentage
        expr: AVG(CASE WHEN IS_BILLABLE THEN 100.0 ELSE 0.0 END)
    filters:
      - name: billable_time
        description: Billable entries only
        expr: "IS_BILLABLE = TRUE"
      - name: approved_time
        description: Approved entries only
        expr: "IS_APPROVED = TRUE"

relationships:
  - name: time_entry_to_consultant
    left_table: time_entries
    right_table: consultants
    relationship_columns:
      - left_column: USER_ID
        right_column: ML_USER_ID

verified_queries:
  - name: monthly_hours
    question: How many hours were logged each month?
    verified_by: Tim Jones
    verified_at: 1740268800
    use_as_onboarding_question: true
    sql: |
      SELECT
        DATE_TRUNC('month', DATE_PERFORMED) as month,
        ROUND(SUM(TIME_IN_HOURS), 1) as total_hours,
        ROUND(SUM(CASE WHEN IS_BILLABLE THEN TIME_IN_HOURS ELSE 0 END), 1) as billable_hours
      FROM ANALYTICS.MART.FACT_TIME_ENTRY
      WHERE YEAR(DATE_PERFORMED) = YEAR(CURRENT_DATE())
      GROUP BY DATE_TRUNC('month', DATE_PERFORMED)
      ORDER BY month

  - name: consultant_hours
    question: How many hours has each consultant logged?
    verified_by: Tim Jones
    verified_at: 1740268800
    use_as_onboarding_question: true
    sql: |
      SELECT
        USER_NAME as consultant,
        ROUND(SUM(TIME_IN_HOURS), 1) as total_hours,
        ROUND(SUM(CASE WHEN IS_BILLABLE THEN TIME_IN_HOURS ELSE 0 END), 1) as billable_hours
      FROM ANALYTICS.MART.FACT_TIME_ENTRY
      GROUP BY USER_NAME
      ORDER BY total_hours DESC
